#include <stdio.h>
#include <stdlib.h>
#include <string.h>

struct Book {
    int id;
    char title[50];
    char author[50];
    int available; // 1 = available, 0 = issued
    struct Book *next;
};

struct Student {
    int id;
    char name[50];
    char bookTitle[50];
    struct Student *next;
};

struct Book *library = NULL;
struct Student *students = NULL;

// Admin credentials
char adminUser[50];
char adminPass[50];

// Function Prototypes
void createAdmin();
int loginAdmin();
void addBook();
void displayBooks();
void searchBook();
void issueBook();
void returnBook();
void deleteBook();

// Create Admin Account
void createAdmin() {
    printf("\n===== CREATE ADMIN ACCOUNT =====\n");
    printf("Create Username: ");
    fgets(adminUser, 50, stdin);
    adminUser[strcspn(adminUser, "\n")] = '\0';

    printf("Create Password: ");
    fgets(adminPass, 50, stdin);
    adminPass[strcspn(adminPass, "\n")] = '\0';

    printf("Admin account created successfully!\n");
}

// Login Function
int loginAdmin() {
    char u[50], p[50];

    printf("\n===== ADMIN LOGIN =====\n");
    printf("Enter Username: ");
    fgets(u, 50, stdin);
    u[strcspn(u, "\n")] = '\0';

    printf("Enter Password: ");
    fgets(p, 50, stdin);
    p[strcspn(p, "\n")] = '\0';

    if (strcmp(u, adminUser) == 0 && strcmp(p, adminPass) == 0) {
        printf("Login Successful!\n");
        return 1;
    } else {
        printf("Invalid Username or Password!\n");
        return 0;
    }
}

int main() {
    int choice;

    // Create admin first time
    printf("No admin found. Please create admin account.\n");
    createAdmin();

    // Login required
    printf("\nPlease Login to continue...\n");
    while (loginAdmin() == 0) {
        printf("Try Again!\n");
    }

    while (1) {
        printf("\n====== DIGITAL LIBRARY MANAGEMENT SYSTEM ======\n");
        printf("1. Add Book\n");
        printf("2. Display Books\n");
        printf("3. Search Book\n");
        printf("4. Issue Book\n");
        printf("5. Return Book\n");
        printf("6. Delete Book\n");
        printf("7. Exit\n");
        printf("Enter your choice: ");
        scanf("%d", &choice);
        getchar(); // clear input buffer

        switch (choice) {
            case 1: addBook(); break;
            case 2: displayBooks(); break;
            case 3: searchBook(); break;
            case 4: issueBook(); break;
            case 5: returnBook(); break;
            case 6: deleteBook(); break;
            case 7: exit(0);
            default: printf("Invalid choice!\n");
        }
    }
    return 0;
}

// Function to add a new book
void addBook() {
    struct Book newBook = (struct Book)malloc(sizeof(struct Book));
    printf("Enter Book ID: ");
    scanf("%d", &newBook->id);
    getchar();

    printf("Enter Book Title: ");
    fgets(newBook->title, 50, stdin);
    newBook->title[strcspn(newBook->title, "\n")] = '\0';

    printf("Enter Author Name: ");
    fgets(newBook->author, 50, stdin);
    newBook->author[strcspn(newBook->author, "\n")] = '\0';

    newBook->available = 1;
    newBook->next = library;
    library = newBook;

    printf("Book added successfully!\n");
}

// Function to display all books
void displayBooks() {
    struct Book *temp = library;
    if (temp == NULL) {
        printf("No books in library.\n");
        return;
    }
    printf("\n---- Library Books ----\n");
    while (temp != NULL) {
        printf("ID: %d | Title: %s | Author: %s | Status: %s\n",
               temp->id, temp->title, temp->author,
               temp->available ? "Available" : "Issued");
        temp = temp->next;
    }
}

// Function to search a book
void searchBook() {
    int id;
    char title[50];
    int choice, found = 0;

    printf("Search by:\n1. ID\n2. Title\nEnter choice: ");
    scanf("%d", &choice);
    getchar();

    struct Book *temp = library;

    if (choice == 1) {
        printf("Enter Book ID: ");
        scanf("%d", &id);
        while (temp != NULL) {
            if (temp->id == id) {
                printf("Found: %s by %s (%s)\n",
                       temp->title, temp->author,
                       temp->available ? "Available" : "Issued");
                found = 1;
                break;
            }
            temp = temp->next;
        }
    } else if (choice == 2) {
        printf("Enter Book Title: ");
        fgets(title, 50, stdin);
        title[strcspn(title, "\n")] = '\0';
        while (temp != NULL) {
            if (strcmp(temp->title, title) == 0) {
                printf("Found: %s by %s (%s)\n",
                       temp->title, temp->author,
                       temp->available ? "Available" : "Issued");
                found = 1;
                break;
            }
            temp = temp->next;
        }
    }

    if (!found)
        printf("Book not found!\n");
}

// Function to issue a book
void issueBook() {
    int id;
    char studentName[50];
    printf("Enter Book ID to issue: ");
    scanf("%d", &id);
    getchar();

    struct Book *temp = library;
    while (temp != NULL && temp->id != id)
        temp = temp->next;

    if (temp == NULL) {
        printf("Book not found!\n");
        return;
    }
    if (!temp->available) {
        printf("Book already issued!\n");
        return;
    }

    printf("Enter Student Name: ");
    fgets(studentName, 50, stdin);
    studentName[strcspn(studentName, "\n")] = '\0';

    struct Student newStudent = (struct Student)malloc(sizeof(struct Student));
    newStudent->id = id;
    strcpy(newStudent->name, studentName);
    strcpy(newStudent->bookTitle, temp->title);
    newStudent->next = students;
    students = newStudent;

    temp->available = 0;
    printf("Book issued successfully to %s!\n", studentName);
}

// Function to return a book
void returnBook() {
    int id;
    printf("Enter Book ID to return: ");
    scanf("%d", &id);

    struct Student *sTemp = students, *prev = NULL;
    while (sTemp != NULL && sTemp->id != id) {
        prev = sTemp;
        sTemp = sTemp->next;
    }

    if (sTemp == NULL) {
        printf("No record found for this book ID.\n");
        return;
    }

    // Mark book available
    struct Book *bTemp = library;
    while (bTemp != NULL) {
        if (bTemp->id == id) {
            bTemp->available = 1;
            break;
        }
        bTemp = bTemp->next;
    }

    // Delete student issue record
    if (prev == NULL)
        students = sTemp->next;
    else
        prev->next = sTemp->next;

    free(sTemp);
    printf("Book returned successfully!\n");
}

// Delete a book
void deleteBook() {
    int id;
    printf("Enter Book ID to delete: ");
    scanf("%d", &id);

    struct Book *temp = library, *prev = NULL;
    while (temp != NULL && temp->id != id) {
        prev = temp;
        temp = temp->next;
    }

    if (temp == NULL) {
        printf("Book not found!\n");
        return;
    }

    if (prev == NULL)
        library = temp->next;
    else
        prev->next = temp->next;

    free(temp);
    printf("Book deleted successfully!\n");
}